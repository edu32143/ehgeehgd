<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ci√™ncia Interativa 2.1</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --font-primary: 'Poppins', sans-serif;
            --cor-fundo: #F8F9FA;
            --cor-card: rgba(255, 255, 255, 0.6);
            --cor-texto-primario: #212529;
            --cor-texto-secundario: #6C757D;
            --cor-borda-vidro: rgba(200, 200, 220, 0.4);
            --cor-sombra: rgba(0, 0, 0, 0.1);
            --cor-fisica: #007BFF;
            --cor-quimica: #7E57C2;
            --cor-biologia: #28A745;
            --cor-matematica: #FFC107;
            --cor-geral: #007BFF;
            --cor-correto: #28A745;
            --cor-errado: #DC3545;
            --cor-neutro: #FFC107;
            --glass-blur: 15px;
            --transition-speed: 0.4s;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-primary);
            background-color: var(--cor-fundo);
            color: var(--cor-texto-primario);
            overflow-x: hidden;
            text-align: center;
            transition: background-color var(--transition-speed) ease;
        }
        #dynamic-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; min-height: 100vh; height: auto;
            padding: 2rem; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
            padding-top: 6rem;
            opacity: 0; visibility: hidden;
            transform: translateY(20px);
            transition: opacity var(--transition-speed) ease-out, transform var(--transition-speed) ease-out, visibility 0s var(--transition-speed);
            overflow-y: auto;
        }
        .screen#mainMenu, .screen#gameLobbyScreen { justify-content: center; padding-top: 2rem; }
        .screen.active {
            opacity: 1;
            transform: translateY(0); visibility: visible;
            transition: opacity var(--transition-speed) ease-out, transform var(--transition-speed) ease-out;
        }
        .glass-card {
            background: var(--cor-card);
            border: 1px solid var(--cor-borda-vidro);
            border-radius: 20px; backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: 0 8px 32px 0 var(--cor-sombra);
            padding: clamp(1.5rem, 4vw, 2.5rem);
            transition: all var(--transition-speed) ease;
            width: 100%;
        }
        .page-header {
            position: absolute;
            top: 1rem; left: 1rem; right: 1rem;
            width: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .page-title {
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 800; margin-bottom: 0.5rem;
            background: linear-gradient(45deg, var(--cor-fisica), var(--cor-quimica));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .page-subtitle {
            font-size: clamp(1rem, 2vw, 1.2rem);
            color: var(--cor-texto-secundario);
            font-weight: 400; margin-bottom: 2.5rem; max-width: 800px;
        }
        .btn {
            padding: 0.8rem 1.8rem;
            font-size: 1rem; font-weight: 600;
            border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
            border: 2px solid transparent; display: inline-flex; align-items: center;
            gap: 0.5rem; justify-content: center; text-decoration: none;
        }
        .btn-primary { background-color: var(--cor-geral); color: white; }
        .btn:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 10px 20px rgba(0, 123, 255, 0.2); }
        .btn-secondary { background-color: transparent; color: var(--cor-texto-secundario); border: 2px solid var(--cor-borda-vidro); }
        .btn-secondary:hover { border-color: var(--cor-geral); color: var(--cor-geral); box-shadow: none; background-color: rgba(0, 123, 255, 0.1); }
        .btn-danger { background-color: var(--cor-errado); color: white; border-color: transparent; }
        .btn-danger:hover { background-color: #a71d2a; box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3); }
        .btn-success { background-color: var(--cor-correto); color: white; }
        .btn-success:hover { box-shadow: 0 10px 20px rgba(40, 167, 69, 0.2); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .input-field, .select-field {
            width: 100%;
            padding: 1rem; font-size: 1rem;
            background-color: rgba(248, 249, 250, 0.9);
            border: 1px solid var(--cor-borda-vidro); border-radius: 12px;
            color: var(--cor-texto-primario); margin-bottom: 1rem;
            font-family: var(--font-primary);
        }
        .form-group { width: 100%; text-align: left; margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        #mainMenu .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem; max-width: 1200px;
        }
        .subject-card { cursor: pointer; text-align: center; color: var(--cor-texto-primario); transform-style: preserve-3d; }
        .subject-card:hover { transform: translateY(-15px) rotateX(5deg) rotateY(-5deg); box-shadow: 0 20px 40px var(--cor-sombra); }
        .subject-card .icon { font-size: 4rem; margin-bottom: 1rem; transition: color 0.3s ease; }
        .subject-card h2 { font-size: 2rem; font-weight: 700; }
        .subject-card.fisica .icon { color: var(--cor-fisica); }
        .subject-card.quimica .icon { color: var(--cor-quimica); }
        .subject-card.biologia .icon { color: var(--cor-biologia); }
        .subject-card.matematica .icon { color: var(--cor-matematica); }
        .actions-bar { margin-top: 2rem; display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
        .actions-bar .btn { min-width: 250px; }
        #quizScreen { max-width: 1200px; }
        .quiz-header {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            margin-bottom: 1.5rem; padding: 1rem; position: sticky; top: 1rem; z-index: 10;
        }
        .quiz-stat { font-size: 1.3rem; font-weight: 600; }
        #player-score-container { text-align: left; }
        #timer-container { text-align: center; font-size: 2rem; }
        .quiz-header-right { display: flex; justify-content: flex-end; gap: 1.5rem; }
        .quiz-question-area { padding: 2rem; margin-bottom: 1.5rem; min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #questionMedia { margin-bottom: 1rem; max-width: 100%; max-height: 200px; border-radius: 10px; object-fit: cover; }
        #questionText { font-size: clamp(1.5rem, 3vw, 2.2rem); font-weight: 700; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%; }
        .option-button { padding: 1.5rem; font-size: 1.2rem; font-weight: 600; border-radius: 12px; cursor: pointer; color: white; display: flex; align-items: center; gap: 1rem; min-height: 80px; }
        .option-button:disabled { opacity: 0.6; cursor: not-allowed; }
        .option-button .shape { font-size: 1.5rem; }
        .option-button.triangulo { background-color: #c0392b; }
        .option-button.losango { background-color: #2980b9; }
        .option-button.circulo { background-color: #f39c12; }
        .option-button.quadrado { background-color: #27ae60; }
        .option-button.correct { animation: pulseCorrect 0.8s; background-color: var(--cor-correto) !important; }
        .option-button.wrong { animation: shake 0.5s; background-color: var(--cor-errado) !important; opacity: 0.5; }
        .option-button.reveal-correct { animation: pulseCorrect 0.8s; border: 4px solid white; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 50%, 90% { transform: translateX(-8px); } 30%, 70% { transform: translateX(8px); } }
        @keyframes pulseCorrect { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { width: 90%; max-width: 500px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h3 { margin-bottom: 1.5rem; font-size: 1.8rem; }
        .modal-buttons { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;}
        .list-item { background: rgba(255,255,255,0.5); border: 1px solid var(--cor-borda-vidro); padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; text-align: left; }
        .list-item-title { font-weight: 600; font-size: 1.1rem; }
        .list-item-actions button { background: none; border: none; color: var(--cor-texto-secundario); cursor: pointer; font-size: 1.1rem; margin-left: 0.5rem; padding: 0.5rem; transition: color 0.3s; }
        .list-item-actions button:hover { color: var(--cor-texto-primario); }
        .question-editor { background: rgba(0,0,0,0.05); padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; border: 1px dashed var(--cor-borda-vidro); cursor: grab; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .question-editor.is-dragging { opacity: 0.8; transform: scale(1.02); box-shadow: 0 10px 30px var(--cor-sombra); cursor: grabbing; z-index: 100; position: relative; }
        .option-editor { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; }
        .option-editor input[type="radio"] { width: 20px; height: 20px; flex-shrink: 0; }
        .media-upload-area { display: flex; align-items: center; gap: 1rem; }
        .media-upload-area .media-preview { width: 80px; height: 60px; border-radius: 8px; background: #eee; object-fit: cover; }
        .media-upload-area .input-field { margin-bottom: 0; }
        #gameLobbyScreen .lobby-code { font-size: clamp(2rem, 8vw, 4rem); font-weight: 800; letter-spacing: 5px; background: var(--cor-geral); color: white; padding: 1rem 2rem; border-radius: 15px; margin: 1rem 0; }
        #playerList { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.5rem; justify-content: center; text-align: center; margin-top: 2rem; width:100%; max-width:1200px; }
        .player-chip { background: white; color: var(--cor-texto-primario); font-weight: 600; padding: 0.8rem 1.2rem; border-radius: 15px; box-shadow: 0 4px 10px var(--cor-sombra); animation: popIn 0.3s ease-out; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .player-avatar { font-size: 2.5rem; line-height: 1; width: 50px; height: 50px; display:flex; align-items:center; justify-content:center; background-color: #eee; border-radius: 50%; overflow: hidden; }
        .player-avatar img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #leaderboardOverlay .modal-content { max-width: 600px; }
        .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border-bottom: 1px solid var(--cor-borda-vidro); font-size: 1.2rem; }
        .leaderboard-item:last-child { border-bottom: none; }
        .leaderboard-item .rank { font-weight: 800; width: 30px; }
        .leaderboard-item .name { flex-grow: 1; text-align: left; margin-left: 1rem; }
        .leaderboard-item .score { font-weight: 600; }
        #marketplaceScreen .filters { margin-bottom: 2rem; display: flex; gap: 1rem; justify-content: center; }
        #marketplace-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; max-width: 1400px; }
        .marketplace-card { text-align: left; }
        .marketplace-card h3 { font-size: 1.4rem; margin-bottom: 0.5rem; }
        .marketplace-card p { font-size: 0.9rem; color: var(--cor-texto-secundario); margin-bottom: 1rem; }
        .marketplace-card .author { font-weight: 600; }
        .marketplace-card .stats { display: flex; gap: 1.5rem; margin-top: 1.5rem; border-top: 1px solid var(--cor-borda-vidro); padding-top: 1.5rem; }
        .marketplace-card .stats span { font-weight: 600; }
        .quiz-cover-image { width: 100%; height: 180px; object-fit: cover; border-radius: 12px; margin-bottom: 1rem; border: 1px solid var(--cor-borda-vidro); }
        #avatar-selection { margin-top: 1.5rem; }
        .emoji-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(40px, 1fr)); gap: 0.5rem; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.05); padding: 0.5rem; border-radius: 10px; }
        .emoji-btn { font-size: 1.8rem; cursor: pointer; background: none; border: 2px solid transparent; border-radius: 8px; transition: all 0.2s; }
        .emoji-btn:hover { background-color: rgba(0,0,0,0.1); }
        .emoji-btn.selected { border-color: var(--cor-geral); background-color: rgba(0,123,255,0.2); }
        .avatar-preview-container { display: flex; justify-content: center; margin-bottom: 1rem; }
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; background: #e9ecef; display: flex; align-items: center; justify-content: center; font-size: 3rem; overflow: hidden; border: 2px solid var(--cor-borda-vidro); }
        .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-choices { display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1rem; }
        .avatar-choices .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        input[type="file"].hidden-upload { display: none; }
        #cameraView { max-width: 100%; border-radius: 10px; }
        #progress-bar-container { width: 100%; height: 8px; background-color: rgba(0,0,0,0.1); border-radius: 4px; margin-bottom: 1rem; }
        #progress-bar { height: 100%; width: 0%; background-color: var(--cor-geral); border-radius: 4px; transition: width 0.5s ease; }
        #lives-container { display: flex; gap: 0.5rem; align-items: center; }
        #streak-container { display: flex; gap: 0.5rem; align-items: center; color: var(--cor-neutro); font-weight: 600; }
        #fullscreen-feedback { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; display: flex; justify-content: center; align-items: center; font-size: 5rem; font-weight: 800; color: white; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #fullscreen-feedback.correct { background-color: rgba(40, 167, 69, 0.8); }
        #fullscreen-feedback.incorrect { background-color: rgba(220, 53, 69, 0.8); }
        #fullscreen-feedback.show { opacity: 1; }
        .sound-controls { display: flex; align-items: center; gap: 0.5rem; }
        .sound-controls button { font-size: 1.2rem; background: none; border: none; cursor: pointer; color: var(--cor-texto-secundario); }
        @media (max-width: 768px) {
            .options-grid { grid-template-columns: 1fr; }
            .actions-bar { flex-direction: column; align-items: center; }
            .page-title { font-size: 2rem; }
            .page-header { top: 1rem; left: 1rem; }
            .quiz-header { grid-template-columns: 1fr 1fr; gap: 1rem; }
            #timer-container { grid-column: 1 / -1; order: -1; text-align: center; }
            .quiz-header-right { justify-content: flex-end; }
        }
    </style>
</head>
<body>
    <canvas id="dynamic-background"></canvas>
    <div id="fullscreen-feedback"></div>
    
    <main id="mainMenu" class="screen active">
        <h1 class="page-title">Ci√™ncia Interativa 2.1</h1>
        <p class="page-subtitle">Sua jornada de conhecimento come√ßa agora. Escolha uma mat√©ria para um jogo r√°pido ou entre em uma sala.</p>
        
        <div class="content-grid">
            <div class="glass-card subject-card fisica" data-action="start-default-quiz" data-subject="fisica">
                <div class="icon"><i class="fas fa-atom"></i></div>
                <h2>F√≠sica</h2><p>Descubra as leis que movem o universo.</p>
            </div>
            <div class="glass-card subject-card quimica" data-action="start-default-quiz" data-subject="quimica">
                <div class="icon"><i class="fas fa-flask-vial"></i></div>
                <h2>Qu√≠mica</h2><p>Explore a mat√©ria e suas transforma√ß√µes.</p>
            </div>
            <div class="glass-card subject-card biologia" data-action="start-default-quiz" data-subject="biologia">
                <div class="icon"><i class="fas fa-dna"></i></div>
                <h2>Biologia</h2><p>Entenda as maravilhas da vida.</p>
            </div>
            <div class="glass-card subject-card matematica" data-action="start-default-quiz" data-subject="matematica">
                <div class="icon"><i class="fas fa-calculator"></i></div>
                <h2>Matem√°tica</h2><p>Desvende a linguagem dos n√∫meros.</p>
            </div>
        </div>

        <div class="actions-bar glass-card">
            <button class="btn btn-primary" data-action="show-modal" data-target="joinGameModal"><i class="fas fa-gamepad"></i> Entrar em Sala (Aluno)</button>
            <button class="btn btn-secondary" data-action="google-login"><i class="fab fa-google"></i> √Årea do Professor</button>
            <button class="btn btn-secondary" data-action="navigate" data-target="marketplaceScreen"><i class="fas fa-store"></i> Marketplace de Quizzes</button>
            <button id="adminPanelBtn" class="btn btn-secondary" data-action="navigate" data-target="adminPanel" style="display: none; border-color: var(--cor-quimica); color: var(--cor-quimica);"><i class="fas fa-user-shield"></i> Painel Admin</button>
        </div>
    </main>
    
    <section id="quizScreen" class="screen">
        <div class="page-header">
            <button class="btn btn-secondary" data-action="navigate" data-target="mainMenu"><i class="fas fa-arrow-left"></i> Sair</button>
            <div class="sound-controls">
                <button id="soundToggleBtn"><i class="fas fa-volume-up"></i></button>
            </div>
        </div>
        <div class="quiz-content-wrapper" style="width: 100%; max-width: 1200px;">
            <header class="quiz-header glass-card">
                <div id="player-score-container" class="quiz-stat">Pontua√ß√£o: <span id="score">0</span></div>
                <div id="timer-container" class="quiz-stat"><i class="fas fa-clock"></i> <span id="timer">--</span></div>
                <div class="quiz-header-right">
                    <div id="lives-container"></div>
                    <div id="streak-container"></div>
                    <div id="question-counter-container" class="quiz-stat">Quest√£o: <span id="currentQuestion">1</span>/<span id="totalQuestions">0</span></div>
                </div>
            </header>
            <div id="progress-bar-container"><div id="progress-bar"></div></div>
            <div class="quiz-question-area glass-card">
                 <img id="questionMedia" src="" alt="M√≠dia da quest√£o" style="display: none;">
                 <h2 id="questionText">Carregando pergunta...</h2>
            </div>
            <div id="optionsContainer" class="options-grid"></div>
        </div>
    </section>

    <section id="professorPanel" class="screen">
        <div class="page-header">
            <div id="teacher-profile-placeholder" style="display: flex; align-items: center; gap: 1rem;">
                <img id="teacherAvatarDisplay" src="https://via.placeholder.com/40" alt="Avatar" style="border-radius: 50%;">
                <span id="teacherNameDisplay">Professora</span>
            </div>
            <button class="btn btn-secondary" data-action="logout"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
        <h1 class="page-title" style="text-align: center;">√Årea do Professor</h1>
        <p class="page-subtitle">Gerencie seus quizzes, crie novas avalia√ß√µes e acompanhe o desempenho dos alunos.</p>
        <div class="glass-card" style="max-width: 900px; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <h3 style="margin: 0;">Meus Quizzes</h3>
                <button class="btn btn-primary" data-action="go-to-editor"><i class="fas fa-plus"></i> Criar Novo Quiz</button>
            </div>
            <div id="customQuizzesList"><p>Carregando seus quizzes...</p></div>
        </div>
    </section>

    <section id="createQuizScreen" class="screen">
        <div class="page-header"><button class="btn btn-secondary" data-action="navigate" data-target="professorPanel"><i class="fas fa-arrow-left"></i> Voltar</button></div>
        <h1 id="createQuizTitle" class="page-title" style="text-align: center;">Criar Quiz</h1>
        <p class="page-subtitle">Preencha os dados abaixo para criar ou editar sua avalia√ß√£o.</p>
        <div class="glass-card" style="max-width: 900px; text-align: left;">
            <form id="quizEditorForm">
                <input type="hidden" id="editingQuizId">
                <div class="form-group">
                    <label for="quizName">Nome do Quiz</label>
                    <input type="text" id="quizName" class="input-field" placeholder="Ex: Avalia√ß√£o de Biologia - 1¬∫ Trimestre" required>
                </div>
                <div class="form-group">
                    <label for="quizSubject">Mat√©ria</label>
                    <select id="quizSubject" class="select-field" required>
                        <option value="fisica">F√≠sica</option><option value="quimica">Qu√≠mica</option>
                        <option value="biologia">Biologia</option><option value="matematica">Matem√°tica</option>
                    </select>
                </div>
                <div class="form-group">
                     <label for="quizCoverImage">Imagem de Capa (Opcional)</label>
                    <div class="media-upload-area">
                        <img id="quizCoverPreview" src="https://via.placeholder.com/320x180.png?text=Imagem+de+Capa" class="quiz-cover-image">
                        <input type="file" id="quizCoverImage" class="input-field media-file" accept="image/*">
                        <input type="hidden" id="quizCoverUrl">
                    </div>
                </div>
                <h3 style="margin: 2rem 0 1rem;">Perguntas</h3>
                <hr style="border-color: var(--cor-borda-vidro); margin-bottom: 2rem;">
                <div id="questionsEditorContainer"></div>
                <button type="button" id="addQuestionBtn" class="btn btn-secondary" style="width: 100%; margin: 1rem 0;"><i class="fas fa-plus"></i> Adicionar Pergunta</button>
                <button type="submit" id="saveQuizBtn" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.2rem;"><i class="fas fa-save"></i> Salvar Quiz na Nuvem</button>
            </form>
        </div>
    </section>

    <section id="resultsScreen" class="screen">
         <div class="page-header"><button class="btn btn-secondary" data-action="navigate" data-target="professorPanel"><i class="fas fa-arrow-left"></i> Voltar</button></div>
         <h1 id="resultsQuizTitle" class="page-title" style="text-align: center;">Resultados do Quiz</h1>
         <div class="glass-card" style="max-width: 900px; text-align: left;">
            <h3 style="margin-bottom: 1.5rem;">Desempenho dos Alunos</h3>
            <div id="resultsList"><p>Carregando resultados...</p></div>
         </div>
    </section>

    <section id="gameLobbyScreen" class="screen">
        <div class="page-header"><button class="btn btn-danger" id="leaveLobbyBtn"><i class="fas fa-times"></i> Cancelar/Sair da Sala</button></div>
        <h1 class="page-title" id="lobbyQuizTitle">Aguardando Jogadores</h1>
        <p class="page-subtitle">Professora: <span id="lobbyTeacherName">--</span> | Sala: <span id="lobbyRoomName">--</span></p>
        <p class="page-subtitle">Pe√ßa para os alunos inserirem este c√≥digo para entrar:</p>
        <div id="lobbyRoomCode" class="lobby-code">------</div>
        <div id="playerList" class="glass-card"></div>
        <button id="startGameBtn" class="btn btn-primary" style="padding: 1rem 3rem; font-size: 1.5rem; margin-top: 2rem;" disabled><i class="fas fa-play"></i> Iniciar Jogo</button>
    </section>

    <section id="marketplaceScreen" class="screen">
        <div class="page-header"><button class="btn btn-secondary" data-action="navigate" data-target="mainMenu"><i class="fas fa-arrow-left"></i> Voltar</button></div>
        <h1 class="page-title" style="text-align: center;">Marketplace de Quizzes</h1>
        <p class="page-subtitle">Explore, descubra e clone quizzes incr√≠veis criados por outros educadores da comunidade.</p>
        <div class="filters">
            <input type="search" id="marketplaceSearch" class="input-field" placeholder="Buscar por t√≠tulo ou mat√©ria..." style="max-width: 400px;">
        </div>
        <div id="marketplace-list">
            <p>Carregando quizzes da comunidade...</p>
        </div>
    </section>

    <section id="adminPanel" class="screen">
        <div class="page-header"><button class="btn btn-secondary" data-action="navigate" data-target="mainMenu"><i class="fas fa-arrow-left"></i> Voltar</button></div>
        <h1 class="page-title">Painel de Administra√ß√£o</h1>
        <p class="page-subtitle">Modera√ß√£o de conte√∫do e gerenciamento de professoras.</p>
        <div class="glass-card" style="max-width: 900px; text-align: left;">
            <h3>Moderar Quizzes do Marketplace</h3>
            <p>Aqui voc√™ poder√° ver, editar ou remover quizzes publicados.</p>
            <hr style="border-color: var(--cor-borda-vidro); margin: 1rem 0;">
            <h3>Gerenciar Professoras</h3>
            <p>Aqui voc√™ poder√° bloquear ou desbloquear contas de professoras.</p>
        </div>
    </section>
    
    <div id="joinGameModal" class="modal-overlay">
        <div class="modal-content glass-card">
            <h3>Entrar em uma Sala de Jogo</h3>
            <div class="form-group"><label for="studentNameInput">Seu Nome</label><input type="text" id="studentNameInput" class="input-field" placeholder="Ex: Ana Silva" required></div>
            <div class="form-group"><label for="roomCodeInput">C√≥digo da Sala</label><input type="text" id="roomCodeInput" class="input-field" placeholder="Ex: 123456" required></div>
            <div class="form-group"><label for="roomPasswordInput">Senha da Sala</label><input type="password" id="roomPasswordInput" class="input-field" placeholder="Pe√ßa a senha para a professora" required></div>
            <p id="joinRoomError" style="color: var(--cor-errado); display: none; margin-top: -0.5rem; margin-bottom: 1rem;">Erro.</p>
            
            <div id="avatar-selection">
                <label>Seu Avatar</label>
                <div class="avatar-preview-container">
                    <div id="avatarPreview" class="avatar-preview">üòÄ</div>
                </div>
                <div class="avatar-choices">
                    <button id="chooseEmojiBtn" class="btn btn-secondary btn-sm"><i class="fas fa-smile"></i> Emojis</button>
                    <label for="studentAvatarUpload" class="btn btn-secondary btn-sm"><i class="fas fa-image"></i> Enviar Foto</label>
                    <input type="file" id="studentAvatarUpload" class="hidden-upload" accept="image/*">
                    <button id="takePhotoBtn" class="btn btn-secondary btn-sm"><i class="fas fa-camera"></i> Tirar Foto</button>
                </div>
                <div id="emoji-grid-container" style="display: block;">
                    <div class="emoji-grid">
                        <button class="emoji-btn" data-emoji="üòÄ">üòÄ</button><button class="emoji-btn" data-emoji="üòé">üòé</button><button class="emoji-btn" data-emoji="ü§ì">ü§ì</button><button class="emoji-btn" data-emoji="üßê">üßê</button><button class="emoji-btn" data-emoji="üë©‚Äçüî¨">üë©‚Äçüî¨</button><button class="emoji-btn" data-emoji="üë®‚Äçüî¨">üë®‚Äçüî¨</button><button class="emoji-btn" data-emoji="üëΩ">üëΩ</button><button class="emoji-btn" data-emoji="ü§ñ">ü§ñ</button><button class="emoji-btn" data-emoji="üê∂">üê∂</button><button class="emoji-btn" data-emoji="üê±">üê±</button><button class="emoji-btn" data-emoji="ü¶ä">ü¶ä</button><button class="emoji-btn" data-emoji="üêº">üêº</button><button class="emoji-btn" data-emoji="ü¶Ñ">ü¶Ñ</button><button class="emoji-btn" data-emoji="üêâ">üêâ</button><button class="emoji-btn" data-emoji="ü¶â">ü¶â</button><button class="emoji-btn" data-emoji="ü¶ã">ü¶ã</button><button class="emoji-btn" data-emoji="üåª">üåª</button><button class="emoji-btn" data-emoji="üåç">üåç</button><button class="emoji-btn" data-emoji="üöÄ">üöÄ</button><button class="emoji-btn" data-emoji="‚ö°">‚ö°</button><button class="emoji-btn" data-emoji="üî≠">üî≠</button><button class="emoji-btn" data-emoji="üî¨">üî¨</button><button class="emoji-btn" data-emoji="üß™">üß™</button><button class="emoji-btn" data-emoji="üßÆ">üßÆ</button>
                    </div>
                </div>
            </div>
            <div class="modal-buttons"><button data-action="close-modal" class="btn btn-secondary">Cancelar</button><button id="submitJoinBtn" class="btn btn-primary">Participar</button></div>
        </div>
    </div>
    
    <div id="takePhotoModal" class="modal-overlay">
        <div class="modal-content glass-card">
            <h3>Tirar Foto</h3>
            <video id="cameraView" autoplay playsinline></video>
            <canvas id="photoCanvas" style="display:none;"></canvas>
            <div class="modal-buttons">
                <button id="capturePhotoBtn" class="btn btn-primary"><i class="fas fa-camera"></i> Capturar</button>
                <button id="cancelPhotoBtn" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="createRoomModal" class="modal-overlay">
        <div class="modal-content glass-card">
            <h3>Criar Nova Sala de Jogo</h3>
            <input type="hidden" id="createRoomQuizId">
            <div class="form-group"><label for="createRoomNameInput">Nome da Sala</label><input type="text" id="createRoomNameInput" class="input-field" placeholder="Ex: Turma 301 - Revis√£o" required></div>
            <div class="form-group"><label for="createRoomPasswordInput">Senha da Sala</label><input type="text" id="createRoomPasswordInput" class="input-field" placeholder="Crie uma senha para os alunos" required></div>
            <div class="form-group">
                <label for="timePerQuestionSelect">Tempo por Pergunta</label>
                <select id="timePerQuestionSelect" class="select-field">
                    <option value="30">30 segundos (Padr√£o)</option>
                    <option value="15">15 segundos (R√°pido)</option>
                    <option value="60">60 segundos (Lento)</option>
                </select>
            </div>
            <div class="modal-buttons"><button data-action="close-modal" class="btn btn-secondary">Cancelar</button><button id="submitCreateRoomBtn" class="btn btn-primary">Criar Sala</button></div>
        </div>
    </div>

    <div id="leaderboardOverlay" class="modal-overlay">
        <div class="modal-content glass-card">
            <h3 id="leaderboardTitle">Placar</h3>
            <div id="leaderboardContent"></div>
            <div class="modal-buttons">
                <button id="nextQuestionBtn" class="btn btn-primary">Pr√≥xima Pergunta</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // =======================================================================
        // 1. INICIALIZA√á√ÉO DO SUPABASE E VARI√ÅVEIS GLOBAIS
        // =======================================================================
        const SUPABASE_URL = 'https://uerjfiskphniyrjldeik.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlcmpmaXNrcGhuaXlyamxkZWlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NDc1NjUsImV4cCI6MjA3MTAyMzU2NX0.KxkBbpmUzYa-o6jMYdj06nlThoUpJEw6poGLJlSs_dY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log("Ci√™ncia Interativa 2.1 (Supabase Edition): INICIALIZADO.");

        let currentScreenId = 'mainMenu';
        let score = 0, currentQuestionIndex = 0, lives = 3, streak = 0;
        let currentQuiz = [], questionEditorCounter = 0;
        let activeListeners = { roomChannel: null, cameraStream: null };
        let gameTimerInterval = null;
        let isSoundOn = true;
        let studentSelectedAvatar = 'üòÄ'; // Padr√£o
        const ADMIN_EMAIL = "joseeduardocorreiadeoliveirao@gmail.com";
        
        let gameState = {
            isHost: false,
            roomCode: null,
            playerId: `player_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
            playerName: null,
            playerAvatar: "üòÄ",
            playerEmail: null,
            currentQuizData: null,
            questionStartTime: 0
        };

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const defaultContent = {
            fisica: { quiz: [
                {q: "Qual lei afirma que um corpo em repouso tende a ficar em repouso?", o: ["In√©rcia", "A√ß√£o e Rea√ß√£o", "Din√¢mica", "Gravita√ß√£o"], a: "In√©rcia"},
                {q: "O que a segunda lei de Newton (F=ma) descreve?", o: ["A rela√ß√£o entre for√ßa, massa e acelera√ß√£o", "A conserva√ß√£o de energia", "A atra√ß√£o gravitacional", "O movimento dos planetas"], a: "A rela√ß√£o entre for√ßa, massa e acelera√ß√£o"},
                {q: "Qual √© a unidade de medida da For√ßa no Sistema Internacional?", o: ["Newton (N)", "Joule (J)", "Watt (W)", "Pascal (Pa)"], a: "Newton (N)"},
                {q: "A energia associada ao movimento de um corpo √© chamada de:", o: ["Energia Cin√©tica", "Energia Potencial", "Energia T√©rmica", "Energia El√°stica"], a: "Energia Cin√©tica"},
                {q: "Qual o princ√≠pio que explica o funcionamento de um foguete?", o: ["A√ß√£o e Rea√ß√£o (3¬™ Lei de Newton)", "In√©rcia (1¬™ Lei de Newton)", "Lei da Gravita√ß√£o Universal", "Princ√≠pio de Arquimedes"], a: "A√ß√£o e Rea√ß√£o (3¬™ Lei de Newton)"},
                {q: "A luz se comporta como onda e tamb√©m como...", o: ["Part√≠cula", "G√°s", "L√≠quido", "Plasma"], a: "Part√≠cula"},
                {q: "O que mede a grandeza f√≠sica chamada 'Pot√™ncia'?", o: ["A rapidez com que o trabalho √© realizado", "A quantidade de calor de um corpo", "A resist√™ncia ao movimento", "A quantidade de mat√©ria"], a: "A rapidez com que o trabalho √© realizado"},
                {q: "Qual o nome do fen√¥meno onde a luz se desvia ao passar de um meio para outro?", o: ["Refra√ß√£o", "Reflex√£o", "Difra√ß√£o", "Polariza√ß√£o"], a: "Refra√ß√£o"},
                {q: "Em um circuito el√©trico, o que se op√µe √† passagem da corrente?", o: ["Resist√™ncia El√©trica", "Tens√£o El√©trica", "Pot√™ncia El√©trica", "Carga El√©trica"], a: "Resist√™ncia El√©trica"},
                {q: "Quem formulou a Teoria da Relatividade?", o: ["Albert Einstein", "Isaac Newton", "Galileu Galilei", "Nikola Tesla"], a: "Albert Einstein"},
            ]},
            quimica: { quiz: [
                {q: "Qual part√≠cula at√¥mica tem carga negativa?", o: ["El√©tron", "Pr√≥ton", "N√™utron", "P√≥sitron"], a: "El√©tron"},
                {q: "Qual √© o s√≠mbolo qu√≠mico da √°gua?", o: ["H‚ÇÇO", "CO‚ÇÇ", "O‚ÇÇ", "NaCl"], a: "H‚ÇÇO"},
                {q: "Na tabela peri√≥dica, os elementos est√£o organizados em ordem crescente de...", o: ["N√∫mero At√¥mico", "Massa At√¥mica", "Raio At√¥mico", "Eletronegatividade"], a: "N√∫mero At√¥mico"},
                {q: "O processo de transforma√ß√£o de um l√≠quido em g√°s √© chamado de:", o: ["Vaporiza√ß√£o", "Condensa√ß√£o", "Solidifica√ß√£o", "Sublima√ß√£o"], a: "Vaporiza√ß√£o"},
                {q: "Qual g√°s √© essencial para a respira√ß√£o humana?", o: ["Oxig√™nio (O‚ÇÇ)", "Di√≥xido de Carbono (CO‚ÇÇ)", "Nitrog√™nio (N‚ÇÇ)", "Hidrog√™nio (H‚ÇÇ)"], a: "Oxig√™nio (O‚ÇÇ)"},
                {q: "Uma subst√¢ncia com pH 7 √© considerada...", o: ["Neutra", "√Åcida", "B√°sica (Alcalina)", "Corrosiva"], a: "Neutra"},
                {q: "Qual √© o metal mais abundante na crosta terrestre?", o: ["Alum√≠nio", "Ferro", "Cobre", "Ouro"], a: "Alum√≠nio"},
                {q: "A liga√ß√£o qu√≠mica que envolve o compartilhamento de el√©trons √© a...", o: ["Liga√ß√£o Covalente", "Liga√ß√£o I√¥nica", "Liga√ß√£o Met√°lica", "Ponte de Hidrog√™nio"], a: "Liga√ß√£o Covalente"},
                {q: "Qual o nome dado a uma rea√ß√£o qu√≠mica que libera calor?", o: ["Exot√©rmica", "Endot√©rmica", "De s√≠ntesis", "De decomposi√ß√£o"], a: "Exot√©rmica"},
                {q: "O que √© uma mol√©cula?", o: ["Um grupo de dois ou mais √°tomos ligados", "A menor parte de um elemento", "Uma part√≠cula subat√¥mica", "Um tipo de √≠on"], a: "Um grupo de dois ou mais √°tomos ligados"},
            ]},
            biologia: { quiz: [
                {q: "Qual organela √© a 'central de energia' da c√©lula?", o: ["Mitoc√¥ndria", "N√∫cleo", "Ribossomo", "Lisossomo"], a: "Mitoc√¥ndria", mediaUrl: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Mitochondrion_-_TEM.jpg/320px-Mitochondrion_-_TEM.jpg", mediaType: "image"},
                {q: "Qual √© o processo pelo qual as plantas produzem seu pr√≥prio alimento?", o: ["Fotoss√≠ntese", "Respira√ß√£o", "Transpira√ß√£o", "Decomposi√ß√£o"], a: "Fotoss√≠ntese"},
                {q: "O que √© o DNA?", o: ["A mol√©cula que carrega a informa√ß√£o gen√©tica", "Uma prote√≠na celular", "Um tipo de a√ß√∫car", "A membrana da c√©lula"], a: "A mol√©cula que carrega a informa√ß√£o gen√©tica"},
                {q: "Qual √© o maior √≥rg√£o do corpo humano?", o: ["Pele", "F√≠gado", "C√©rebro", "Intestino"], a: "Pele"},
                {q: "Qual sistema do corpo √© respons√°vel por combater doen√ßas?", o: ["Sistema Imunol√≥gico", "Sistema Nervoso", "Sistema Digest√≥rio", "Sistema Respirat√≥rio"], a: "Sistema Imunol√≥gico"},
                {q: "A evolu√ß√£o por sele√ß√£o natural foi proposta por...", o: ["Charles Darwin", "Gregor Mendel", "Louis Pasteur", "James Watson"], a: "Charles Darwin"},
                {q: "O sangue √© bombeado para todo o corpo pelo:", o: ["Cora√ß√£o", "Pulm√£o", "Rim", "C√©rebro"], a: "Cora√ß√£o"},
                {q: "Que tipo de c√©lula n√£o possui n√∫cleo definido?", o: ["Procarionte", "Eucarionte", "Neur√¥nio", "Hem√°cia"], a: "Procarionte"},
                {q: "Como s√£o chamados os seres vivos que produzem seu pr√≥prio alimento?", o: ["Aut√≥trofos", "Heter√≥trofos", "Decompositores", "Consumidores"], a: "Aut√≥trofos"},
                {q: "Qual √© a fun√ß√£o dos ribossomos na c√©lula?", o: ["S√≠ntese de prote√≠nas", "Armazenamento de energia", "Digest√£o celular", "Transporte de subst√¢ncias"], a: "S√≠ntese de prote√≠nas"},
            ]},
            matematica: { quiz: [
                {q: "Qual o resultado de 9 x 8?", o: ["72", "63", "81", "64"], a: "72"},
                {q: "Quantos lados tem um hex√°gono?", o: ["6", "5", "7", "8"], a: "6"},
                {q: "Qual √© a raiz quadrada de 144?", o: ["12", "11", "13", "14"], a: "12"},
                {q: "O que √© o n√∫mero Pi (œÄ) aproximadamente?", o: ["3,14", "2,71", "1,61", "4,0"], a: "3,14"},
                {q: "Em um tri√¢ngulo ret√¢ngulo, a soma dos quadrados dos catetos √© igual ao quadrado da...", o: ["Hipotenusa", "√Årea", "Base", "Altura"], a: "Hipotenusa"},
                {q: "Qual o resultado de 5! (fatorial de 5)?", o: ["120", "25", "15", "60"], a: "120"},
                {q: "Um s√©culo tem quantos anos?", o: ["100", "10", "1000", "50"], a: "100"},
                {q: "Qual √© o pr√≥ximo n√∫mero primo depois de 13?", o: ["17", "14", "15", "16"], a: "17"},
                {q: "Se um produto custa R$80 e tem 25% de desconto, qual o pre√ßo final?", o: ["R$60", "R$55", "R$65", "R$70"], a: "R$60"},
                {q: "Qual √© a f√≥rmula da √°rea de um c√≠rculo?", o: ["œÄ * r¬≤", "2 * œÄ * r", "œÄ * d", "base * altura"], a: "œÄ * r¬≤"},
            ]}
        };
        const STREAK_BONUS = 100, BASE_POINTS = 1000;

        // =======================================================================
        // 2. FUN√á√ïES DE UI, NAVEGA√á√ÉO E SOM
        // =======================================================================
        function showScreen(screenId) {
            document.querySelector('.screen.active')?.classList.remove('active');
            document.getElementById(screenId)?.classList.add('active');
            currentScreenId = screenId;
            window.scrollTo(0,0);
            
            const isQuizScreen = screenId === 'quizScreen';
            document.getElementById('player-score-container').style.display = (isQuizScreen && !gameState.roomCode) ? 'block' : 'none';
            document.getElementById('lives-container').style.display = (isQuizScreen && !gameState.roomCode) ? 'flex' : 'none';
            document.getElementById('streak-container').style.display = (isQuizScreen && !gameState.roomCode) ? 'flex' : 'none';
            document.getElementById('question-counter-container').style.display = isQuizScreen ? 'block' : 'none';
        }
        function showModal(modalId) { document.getElementById(modalId)?.classList.add('active'); }
        function hideAllModals() { 
            stopCamera();
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
        }
        
        function playSound(type) {
            if (!isSoundOn || audioContext.state === 'suspended') return;
            // ... (implementa√ß√£o de √°udio)
        }
        document.getElementById('soundToggleBtn').addEventListener('click', () => {
            isSoundOn = !isSoundOn;
            const icon = document.getElementById('soundToggleBtn').querySelector('i');
            icon.className = isSoundOn ? 'fas fa-volume-up' : 'fas fa-volume-mute';
            if(isSoundOn && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });

        function handleInteraction(e) {
            const el = e.currentTarget;
            const action = el.dataset.action;
            const target = el.dataset.target;

            if (action === 'navigate') showScreen(target);
            else if (action === 'show-modal') showModal(target);
            else if (action === 'close-modal') hideAllModals();
            else if (action === 'start-default-quiz') startDefaultQuiz(el.dataset.subject);
            else if (action === 'google-login') handleGoogleLogin();
            else if (action === 'logout') handleLogout();
            else if (action === 'go-to-editor') {
                document.getElementById('quizEditorForm').reset();
                document.getElementById('editingQuizId').value = '';
                document.getElementById('createQuizTitle').textContent = 'Criar Novo Quiz';
                document.getElementById('questionsEditorContainer').innerHTML = '';
                document.getElementById('quizCoverPreview').src = 'https://via.placeholder.com/320x180.png?text=Imagem+de+Capa';
                document.getElementById('quizCoverUrl').value = '';
                questionEditorCounter = 0;
                addQuestionEditor();
                showScreen('createQuizScreen');
            }
        }
        document.querySelectorAll('[data-action]').forEach(el => el.addEventListener('click', handleInteraction));
        
        // =======================================================================
        // 3. L√ìGICA DE AUTENTICA√á√ÉO E PERFIS (SIMULADO)
        // =======================================================================
        function handleGoogleLogin() {
            const userEmail = prompt("Simula√ß√£o de Login:\nDigite seu email do Google:", "professora@exemplo.com");
            if (!userEmail) return;

            gameState.playerEmail = userEmail.trim().toLowerCase();
            gameState.playerName = gameState.playerEmail.split('@')[0];
            document.getElementById('teacherNameDisplay').textContent = gameState.playerName;

            if (gameState.playerEmail === ADMIN_EMAIL) {
                document.getElementById('adminPanelBtn').style.display = 'inline-flex';
            } else {
                document.getElementById('adminPanelBtn').style.display = 'none';
            }
            
            showScreen('professorPanel');
            renderCustomQuizzes();
        }

        function handleLogout() {
            gameState.playerEmail = null;
            gameState.playerName = null;
            document.getElementById('adminPanelBtn').style.display = 'none';
            showScreen('mainMenu');
        }

        // =======================================================================
        // 4. L√ìGICA DO QUIZ PADR√ÉO (SOLO)
        // =======================================================================
        function startDefaultQuiz(subject) {
            if (!defaultContent[subject]) return;
            gameState.roomCode = null; // Garante que √© modo solo
            score = 0; currentQuestionIndex = 0; lives = 3; streak = 0;
            currentQuiz = [...defaultContent[subject].quiz].sort(() => Math.random() - 0.5);
            document.getElementById('score').textContent = score;
            document.getElementById('totalQuestions').textContent = currentQuiz.length;
            updateLivesDisplay();
            updateStreakDisplay();
            showScreen('quizScreen');
            loadQuestion();
        }

        function updateLivesDisplay() {
            const container = document.getElementById('lives-container');
            container.innerHTML = '';
            for (let i = 0; i < lives; i++) {
                container.innerHTML += `<i class="fas fa-heart" style="color: var(--cor-errado);"></i>`;
            }
        }
        function updateStreakDisplay() {
            const container = document.getElementById('streak-container');
            container.innerHTML = streak > 0 ? `<i class="fas fa-fire"></i> ${streak}` : '';
        }

        function loadQuestion() {
            if (lives <= 0) { showFinalScore(); return; }
            if (currentQuestionIndex < currentQuiz.length) {
                const question = currentQuiz[currentQuestionIndex];
                document.getElementById('questionText').textContent = question.q;
                document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
                document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / currentQuiz.length) * 100}%`;
                
                const qMedia = document.getElementById('questionMedia');
                qMedia.style.display = (question.mediaUrl && question.mediaType === 'image') ? 'block' : 'none';
                qMedia.src = question.mediaUrl || '';
                
                const optionsContainer = document.getElementById('optionsContainer');
                optionsContainer.innerHTML = '';
                const options = [...question.o].sort(() => Math.random() - 0.5);
                const shapes = [{ n: 'triangulo', i: '‚ñ≤' }, { n: 'losango', i: '‚ô¶' }, { n: 'circulo', i: '‚óè' }, { n: 'quadrado', i: '‚ñ†' }];
                options.forEach((opt, index) => {
                    const btn = document.createElement('button');
                    btn.className = `option-button ${shapes[index].n}`;
                    btn.innerHTML = `<span class="shape">${shapes[index].i}</span> <span class="text">${opt}</span>`;
                    btn.onclick = () => handleAnswer(btn, opt, question.a);
                    optionsContainer.appendChild(btn);
                });
                playSound('newQuestion');
            } else {
                showFinalScore();
            }
        }
        
        function handleAnswer(btn, selected, correct) {
            document.querySelectorAll('.option-button').forEach(b => { b.disabled = true; });
            if (selected === correct) {
                streak++;
                score += BASE_POINTS + (streak * STREAK_BONUS);
                document.getElementById('score').textContent = score;
                btn.classList.add('correct');
                playSound('correct');
            } else {
                streak = 0;
                lives--;
                btn.classList.add('wrong');
                document.querySelectorAll('.option-button').forEach(optBtn => { if(optBtn.querySelector('.text').textContent === correct) optBtn.classList.add('reveal-correct'); });
                playSound('incorrect');
            }
            updateLivesDisplay();
            updateStreakDisplay();
            setTimeout(() => { currentQuestionIndex++; loadQuestion(); }, 2000);
        }

        function showFinalScore() {
            document.getElementById('questionText').innerHTML = lives <= 0 ? `Fim de Jogo!` : `Quiz Conclu√≠do!`;
            document.getElementById('optionsContainer').innerHTML = `<div class="glass-card" style="grid-column: 1 / -1; text-align: center;"><p style="font-size: 1.5rem;">Sua pontua√ß√£o final foi:</p><p style="font-size: 4rem; font-weight: bold; color: var(--cor-geral);">${score}</p><button class="btn btn-primary" data-action="navigate" data-target="mainMenu" style="margin-top: 2rem;">Voltar ao Menu</button></div>`;
            document.querySelector('#optionsContainer button').addEventListener('click', handleInteraction);
            if (lives <= 0) playSound('gameover');
        }

        // =======================================================================
        // 5. MODO PROFESSOR: CRUD DE QUIZZES COM SUPABASE
        // =======================================================================
        window.renderCustomQuizzes = async function() {
            const listContainer = document.getElementById('customQuizzesList');
            listContainer.innerHTML = '<p>Buscando seus quizzes na nuvem...</p>';
            
            const { data: quizzes, error } = await supabaseClient.from('quizzes').select('*');
            if (error) {
                listContainer.innerHTML = `<p style="color:var(--cor-errado)">Erro ao carregar quizzes: ${error.message}</p>`;
                return;
            }
            
            listContainer.innerHTML = '';
            if (!quizzes || quizzes.length === 0) {
                listContainer.innerHTML = '<p>Voc√™ ainda n√£o criou nenhum quiz. Clique em "Criar Novo Quiz" para come√ßar!</p>';
                return;
            }
            quizzes.forEach(quiz => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div>
                         <div class="list-item-title">${quiz.name}</div>
                        <small style="color:var(--cor-texto-secundario); text-transform: capitalize;">
                            ${quiz.subject} - ${quiz.questions.length} Quest√µes
                        </small>
                    </div>
                    <div class="list-item-actions">
                        <button title="Criar Sala de Jogo" class="btn btn-primary btn-sm" onclick="window.openCreateRoomModal('${quiz.id}')"><i class="fas fa-play"></i> Iniciar</button>
                        <button title="Publicar no Marketplace" class="btn btn-secondary btn-sm" onclick="window.publishQuiz('${quiz.id}')"><i class="fas fa-store"></i></button>
                        <button title="Resultados" onclick="window.viewResults('${quiz.id}', '${quiz.name}')"><i class="fas fa-chart-bar"></i></button>
                        <button title="Editar Quiz" onclick="window.editQuiz('${quiz.id}')"><i class="fas fa-edit"></i></button>
                        <button title="Excluir Quiz" onclick="window.deleteQuiz('${quiz.id}')" class="btn-danger"><i class="fas fa-trash"></i></button>
                    </div>`;
                listContainer.appendChild(item);
            });
        }

        document.getElementById('addQuestionBtn').addEventListener('click', () => addQuestionEditor());
        
        function addQuestionEditor(questionData = null) {
            questionEditorCounter++;
            const container = document.getElementById('questionsEditorContainer');
            const editorDiv = document.createElement('div');
            editorDiv.className = 'question-editor';
            editorDiv.id = `q-editor-${questionEditorCounter}`;
            editorDiv.draggable = true;
            const qText = questionData ? questionData.q : '';
            const mediaUrl = questionData ? questionData.mediaUrl : '';
            const options = questionData ? questionData.o : ['', '', '', ''];
            const correctAnswer = questionData ? questionData.a : '';
            const points = questionData ? (questionData.points || 1000) : 1000;
            
            editorDiv.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
                    <h4 style="margin:0;">Pergunta ${questionEditorCounter}</h4>
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()"><i class="fas fa-trash"></i></button>
                </div>
                <div class="form-group"><input type="text" class="input-field question-title" placeholder="Enunciado da pergunta" value="${qText}" required></div>
                <div class="form-group"><label>M√≠dia da Quest√£o (Opcional)</label><div class="media-upload-area"><img src="${mediaUrl || 'https://via.placeholder.com/80x60.png?text=IMG'}" class="media-preview"><input type="file" class="input-field media-file" accept="image/*"><input type="hidden" class="media-url" value="${mediaUrl}"></div></div>
                <div class="form-group"><label>Pontos por resposta correta</label><input type="number" class="input-field question-points" value="${points}" min="100" max="5000" step="100" required></div>
                <div class="form-group"><label>Op√ß√µes (Marque a correta)</label>
                     ${[0,1,2,3].map(i => `<div class="option-editor"><input type="radio" name="correct-opt-${questionEditorCounter}" value="${i}" ${options[i] === correctAnswer ? 'checked' : ''} required><input type="text" class="input-field option-text" placeholder="Op√ß√£o ${i + 1}" value="${options[i] || ''}" required></div>`).join('')}
                </div>`;
            container.appendChild(editorDiv);

            editorDiv.querySelector('.media-file').addEventListener('change', e => {
                const file = e.target.files[0];
                if (file) {
                    const preview = e.target.closest('.media-upload-area').querySelector('.media-preview');
                    const reader = new FileReader();
                    reader.onload = (event) => { preview.src = event.target.result; };
                    reader.readAsDataURL(file);
                }
            });
            editorDiv.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', editorDiv.id); editorDiv.classList.add('is-dragging'); });
            editorDiv.addEventListener('dragend', () => editorDiv.classList.remove('is-dragging'));
        }
        
        document.getElementById('questionsEditorContainer').addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(e.clientY);
            const draggable = document.querySelector('.is-dragging');
            if (!draggable) return;
            const container = document.getElementById('questionsEditorContainer');
            if (afterElement == null) container.appendChild(draggable);
            else container.insertBefore(draggable, afterElement);
        });

        function getDragAfterElement(y) {
            const draggableElements = [...document.querySelectorAll('.question-editor:not(.is-dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        async function uploadImageAndGetURL(file) {
            if (!file) return null;
            const filePath = `public/${Date.now()}_${file.name}`;
            const { error } = await supabaseClient.storage.from('quizimages').upload(filePath, file);
            if (error) throw error;
            const { data } = supabaseClient.storage.from('quizimages').getPublicUrl(filePath);
            return data.publicUrl;
        }

        document.getElementById('quizEditorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveBtn = document.getElementById('saveQuizBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

            try {
                const quizId = document.getElementById('editingQuizId').value || `QUIZ${Date.now()}`;
                const quizData = {
                    id: quizId,
                    name: document.getElementById('quizName').value,
                    subject: document.getElementById('quizSubject').value,
                    questions: [],
                    coverImageUrl: document.getElementById('quizCoverUrl').value || null,
                };

                const coverFileInput = document.getElementById('quizCoverImage');
                if (coverFileInput.files[0]) {
                    quizData.coverImageUrl = await uploadImageAndGetURL(coverFileInput.files[0]);
                }

                const questionEditors = Array.from(document.querySelectorAll('.question-editor'));
                const questionPromises = questionEditors.map(async (editor) => {
                    const mediaFileInput = editor.querySelector('.media-file');
                    let finalMediaUrl = editor.querySelector('.media-url').value;
                    if (mediaFileInput.files[0]) {
                        finalMediaUrl = await uploadImageAndGetURL(mediaFileInput.files[0]);
                    }
                    
                    const options = Array.from(editor.querySelectorAll('.option-text')).map(input => input.value);
                    const correctRadio = editor.querySelector('input[type="radio"]:checked');
                    if (!correctRadio) throw new Error("Por favor, marque uma resposta correta para cada pergunta.");
                    
                    return {
                        q: editor.querySelector('.question-title').value,
                        o: options,
                        a: options[parseInt(correctRadio.value)],
                        points: parseInt(editor.querySelector('.question-points').value) || 1000,
                        mediaUrl: finalMediaUrl || null,
                        mediaType: finalMediaUrl ? 'image' : null
                    };
                });
                
                quizData.questions = await Promise.all(questionPromises);
                
                const { error } = await supabaseClient.from('quizzes').upsert(quizData);
                if (error) throw error;
                alert('Quiz salvo com sucesso na nuvem!');
                showScreen('professorPanel');
                renderCustomQuizzes();
            } catch (error) {
                alert('Ocorreu um erro ao salvar o quiz: ' + error.message);
                console.error(error);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Quiz na Nuvem';
            }
        });

        window.editQuiz = async (quizId) => {
            const { data: quiz, error } = await supabaseClient.from('quizzes').select('*').eq('id', quizId).single();
            if (error || !quiz) { alert("Quiz n√£o encontrado!"); return; }

            showScreen('createQuizScreen');
            document.getElementById('createQuizTitle').textContent = 'Editar Quiz';
            document.getElementById('editingQuizId').value = quiz.id;
            document.getElementById('quizName').value = quiz.name;
            document.getElementById('quizSubject').value = quiz.subject;
            document.getElementById('quizCoverPreview').src = quiz.coverImageUrl || 'https://via.placeholder.com/320x180.png?text=Imagem+de+Capa';
            document.getElementById('quizCoverUrl').value = quiz.coverImageUrl || '';

            const questionsContainer = document.getElementById('questionsEditorContainer');
            questionsContainer.innerHTML = '';
            questionEditorCounter = 0;
            quiz.questions.forEach(questionData => addQuestionEditor(questionData));
        };

        window.deleteQuiz = async (quizId) => {
            if (confirm(`Tem certeza que deseja excluir este quiz? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                const { error: quizError } = await supabaseClient.from('quizzes').delete().eq('id', quizId);
                await supabaseClient.from('results').delete().eq('quiz_id', quizId);
                await supabaseClient.from('marketplace').delete().eq('id', quizId);
                
                if (quizError) alert('Erro ao excluir o quiz: ' + quizError.message);
                else { alert('Quiz exclu√≠do com sucesso.'); renderCustomQuizzes(); }
            }
        };

        window.viewResults = async (quizId, quizName) => {
            document.getElementById('resultsQuizTitle').textContent = `Resultados: ${quizName}`;
            showScreen('resultsScreen');
            const resultsContainer = document.getElementById('resultsList');
            resultsContainer.innerHTML = '<p>Carregando resultados...</p>';
            
            const { data: results, error } = await supabaseClient.from('results').select('*').eq('quiz_id', quizId);
            if(error){ resultsContainer.innerHTML = `<p style="color:var(--cor-errado)">Erro: ${error.message}</p>`; return; }
            if (!results || results.length === 0) { resultsContainer.innerHTML = '<p>Nenhum resultado encontrado.</p>'; return; }
                
            resultsContainer.innerHTML = '';
            const resultsByRoom = results.reduce((acc, result) => {
                (acc[result.room_code] = acc[result.room_code] || []).push(result);
                return acc;
            }, {});
            
            Object.entries(resultsByRoom).forEach(([roomCode, roomResults]) => {
                const roomDiv = document.createElement('div');
                roomDiv.className = 'glass-card';
                roomDiv.style.marginBottom = '2rem';
                roomDiv.innerHTML = `<h4 style="margin-bottom: 1rem;">Sala: ${roomCode}</h4>`;
                const players = roomResults[0].players_final.sort((a,b) => b.score - a.score);
                players.forEach((player, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'leaderboard-item';
                    playerDiv.innerHTML = `<span class="rank">#${index + 1}</span><span class="name" style="display: flex; align-items: center; gap: 0.5rem;"><span style="font-size: 1.5rem;">${player.avatar}</span>${player.name}</span><span class="score">${player.score}</span>`;
                    roomDiv.appendChild(playerDiv);
                });
                resultsContainer.appendChild(roomDiv);
            });
        };
        
        // =======================================================================
        // 6. MARKETPLACE COM SUPABASE
        // =======================================================================
        async function renderMarketplace() {
            const searchTerm = document.getElementById('marketplaceSearch').value.toLowerCase();
            const container = document.getElementById('marketplace-list');
            container.innerHTML = '<p>Carregando quizzes da comunidade...</p>';
            
            let query = supabaseClient.from('marketplace').select('*');
            if(searchTerm) {
                query = query.or(`name.ilike.%${searchTerm}%,subject.ilike.%${searchTerm}%,author.ilike.%${searchTerm}%`);
            }
            
            const { data: marketplaceData, error } = await query;
            if (error) { container.innerHTML = `<p style="color:var(--cor-errado)">Erro: ${error.message}</p>`; return; }
            if (!marketplaceData || marketplaceData.length === 0) { container.innerHTML = '<p>Nenhum quiz encontrado.</p>'; return; }
                
            container.innerHTML = '';
            marketplaceData.forEach(quiz => {
                const card = document.createElement('div');
                card.className = 'marketplace-card glass-card';
                card.innerHTML = `
                    <img src="${quiz.coverImageUrl || `https://via.placeholder.com/320x180.png?text=${quiz.subject}`}" class="quiz-cover-image">
                    <h3>${quiz.name}</h3>
                    <p>${quiz.description || 'Quiz educativo.'}</p>
                    <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                        <span class="author"><i class="fas fa-user"></i> ${quiz.author || 'An√¥nimo'}</span>
                        <span style="text-transform: capitalize; color: var(--cor-${quiz.subject});"><i class="fas ${getSubjectIcon(quiz.subject)}"></i> ${quiz.subject}</span>
                    </div>
                    <div class="stats">
                        <span><i class="fas fa-question-circle"></i> ${quiz.questions.length} q.</span>
                        <span><i class="fas fa-download"></i> ${quiz.downloads || 0}</span>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="window.cloneQuiz('${quiz.id}')" style="width: 100%;"><i class="fas fa-copy"></i> Clonar para Meus Quizzes</button>
                    </div>`;
                container.appendChild(card);
            });
        }
        
        function getSubjectIcon(subject) {
            switch(subject) {
                case 'fisica': return 'fa-atom';
                case 'quimica': return 'fa-flask-vial';
                case 'biologia': return 'fa-dna';
                case 'matematica': return 'fa-calculator';
                default: return 'fa-book';
            }
        }
        
        window.publishQuiz = async (quizId) => {
            const { data: quizData, error } = await supabaseClient.from('quizzes').select('*').eq('id', quizId).single();
            if (error || !quizData) { alert('Quiz n√£o encontrado!'); return; }
            
            const authorName = gameState.playerName || prompt('Digite seu nome para cr√©ditos:');
            if (!authorName) return;
            const description = prompt('Breve descri√ß√£o (opcional):') || '';
            const publishData = { ...quizData, author: authorName, description, published_at: new Date().toISOString(), downloads: 0 };
            
            const { error: publishError } = await supabaseClient.from('marketplace').upsert(publishData);
            if (publishError) { alert(`Erro: ${publishError.message}`); return; }

            alert('Quiz publicado com sucesso!');
            renderMarketplace();
        };

        window.cloneQuiz = async (originalQuizId) => {
            await supabaseClient.rpc('increment_downloads', { quiz_id_text: originalQuizId });
            
            const { data: originalQuiz, error } = await supabaseClient.from('marketplace').select('*').eq('id', originalQuizId).single();
            if (error || !originalQuiz) { alert('Quiz n√£o encontrado!'); return; }
            
            const newQuizId = `QUIZ${Date.now()}`;
            const { author, description, published_at, downloads, ...quizData } = originalQuiz;
            quizData.id = newQuizId;
            quizData.name = `C√≥pia de ${quizData.name}`;
            
            const { error: insertError } = await supabaseClient.from('quizzes').insert(quizData);
            if(insertError) { alert(`Erro ao clonar: ${insertError.message}`); return; }

            alert('Quiz clonado com sucesso! Verifique sua lista de quizzes na √Årea do Professor.');
            renderMarketplace();
        };

        // =======================================================================
        // 7. SALA DE AULA EM TEMPO REAL E AVATAR DO ALUNO
        // =======================================================================
        
        window.openCreateRoomModal = (quizId) => {
            document.getElementById('createRoomQuizId').value = quizId;
            showModal('createRoomModal');
        };

        document.getElementById('submitCreateRoomBtn').addEventListener('click', async () => {
            const quizId = document.getElementById('createRoomQuizId').value;
            const roomName = document.getElementById('createRoomNameInput').value.trim();
            const password = document.getElementById('createRoomPasswordInput').value.trim();
            const timePerQuestion = parseInt(document.getElementById('timePerQuestionSelect').value);

            if (!quizId || !roomName || !password) {
                alert("Por favor, preencha todos os campos.");
                return;
            }

            const roomCode = Math.floor(100000 + Math.random() * 900000).toString();
            const { data: quizData, error: quizError } = await supabaseClient.from('quizzes').select('name, questions').eq('id', quizId).single();
            if (quizError || !quizData) { alert("Erro: Quiz n√£o encontrado!"); return; }

            const roomData = {
                room_code: roomCode,
                quiz_id: quizId,
                quiz_title: quizData.name,
                host_id: gameState.playerId,
                host_name: gameState.playerName,
                status: 'lobby',
                current_question_index: -1,
                players: {},
                answers: {},
                room_name: roomName,
                password: password,
                time_per_question: timePerQuestion
            };

            const { error: createError } = await supabaseClient.from('gameRooms').insert(roomData);
            if (createError) { alert(`Erro ao criar sala: ${createError.message}`); return; }

            gameState.isHost = true;
            await joinLobby(roomCode, gameState.playerName);
        });

        document.getElementById('submitJoinBtn').addEventListener('click', async () => {
            const playerName = document.getElementById('studentNameInput').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim();
            const password = document.getElementById('roomPasswordInput').value.trim();
            const errorP = document.getElementById('joinRoomError');

            if (!playerName || !roomCode || !password) {
                errorP.textContent = 'Preencha todos os campos!';
                errorP.style.display = 'block';
                return;
            }
            
            const { data: room, error } = await supabaseClient.from('gameRooms').select('password, status').eq('room_code', roomCode).single();
            
            if (error || !room) {
                errorP.textContent = 'C√≥digo da sala n√£o encontrado.';
                errorP.style.display = 'block';
                return;
            }
            if (room.password !== password) {
                errorP.textContent = 'Senha incorreta.';
                errorP.style.display = 'block';
                return;
            }
            if (room.status !== 'lobby') {
                errorP.textContent = 'Este jogo j√° come√ßou ou foi encerrado.';
                errorP.style.display = 'block';
                return;
            }
            
            errorP.style.display = 'none';
            gameState.playerAvatar = studentSelectedAvatar;
            await joinLobby(roomCode, playerName);
        });
        
        async function joinLobby(roomCode, playerName) {
            gameState.roomCode = roomCode;
            gameState.playerName = playerName;
            
            const channel = supabaseClient.channel(`room:${roomCode}`, { config: { presence: { key: gameState.playerId } } });
            
            channel.on('presence', { event: 'sync' }, () => {
                const presenceState = channel.presenceState();
                updatePlayerList(Object.values(presenceState).map(p => p[0]));
            });
            
            channel.subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await channel.track({ name: playerName, avatar: gameState.playerAvatar, id: gameState.playerId, score: 0 });
                }
            });
            
            hideAllModals();
            showScreen('gameLobbyScreen');
            listenToRoomChanges(roomCode, channel);
        }
        
        function updatePlayerList(players) {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            players.forEach(player => {
                const chip = document.createElement('div');
                chip.className = 'player-chip';
                
                let avatarContent = player.avatar || 'üòÄ';
                if (avatarContent.startsWith('data:image')) {
                    avatarContent = `<img src="${player.avatar}" alt="Avatar">`;
                }

                chip.innerHTML = `<div class="player-avatar">${avatarContent}</div><div>${player.name}</div>`;
                playerList.appendChild(chip);
            });
            if (gameState.isHost) {
                document.getElementById('startGameBtn').disabled = players.length === 0;
            }
        }
        
        function listenToRoomChanges(roomCode, channel) {
            if (activeListeners.roomChannel) activeListeners.roomChannel.unsubscribe();
            activeListeners.roomChannel = channel;

            channel.on('postgres_changes', { event: '*', schema: 'public', table: 'gameRooms', filter: `room_code=eq.${roomCode}` }, 
                async (payload) => {
                    if (payload.eventType === 'DELETE') {
                        if (currentScreenId !== 'mainMenu') {
                            alert("A sala de jogo foi fechada pelo professor.");
                            leaveLobby();
                        }
                        return;
                    }

                    const roomData = payload.new;
                    document.getElementById('lobbyQuizTitle').textContent = roomData.quiz_title;
                    document.getElementById('lobbyRoomName').textContent = roomData.room_name;
                    document.getElementById('lobbyTeacherName').textContent = roomData.host_name || 'Professora';
                    document.getElementById('lobbyRoomCode').textContent = roomCode;
                    document.getElementById('startGameBtn').style.display = gameState.isHost ? 'inline-flex' : 'none';

                    if (!gameState.currentQuizData && roomData.quiz_id) {
                         const { data } = await supabaseClient.from(`quizzes`).select('*').eq('id', roomData.quiz_id).single();
                         if (data) gameState.currentQuizData = data;
                    }
                    
                    switch(roomData.status) {
                        case 'in_progress':
                            hideAllModals();
                            showScreen('quizScreen');
                            loadRealtimeQuestion(roomData);
                            break;
                        case 'leaderboard':
                            await showLeaderboard(roomData);
                            break;
                        case 'finished':
                            showFinalLeaderboard(roomData);
                            break;
                    }
                }
            );
        }

        async function handleStartGame() {
            if (gameState.isHost && gameState.roomCode) {
                const presenceState = activeListeners.roomChannel.presenceState();
                const players = Object.fromEntries(
                    Object.values(presenceState).map(p => {
                        const playerData = p[0];
                        return [playerData.id, { name: playerData.name, avatar: playerData.avatar, score: 0, id: playerData.id }];
                    })
                );
                await supabaseClient.from(`gameRooms`).update({
                    status: 'in_progress',
                    current_question_index: 0,
                    question_start_time: new Date().toISOString(),
                    players: players,
                    answers: {}
                }).eq('room_code', gameState.roomCode);
            }
        }

        function startTimer(duration) {
            clearInterval(gameTimerInterval);
            let timeLeft = duration;
            const timerEl = document.getElementById('timer');

            const updateTimer = () => {
                timerEl.textContent = timeLeft;
                if (timeLeft <= 5 && timeLeft > 0) {
                    timerEl.style.transform = 'scale(1.1)';
                    timerEl.style.color = 'var(--cor-errado)';
                } else {
                    timerEl.style.transform = 'scale(1)';
                    timerEl.style.color = 'var(--cor-texto-primario)';
                }

                if (timeLeft <= 0) {
                    clearInterval(gameTimerInterval);
                    if (gameState.isHost) { advanceToLeaderboard(); }
                }
                timeLeft--;
            };

            updateTimer();
            gameTimerInterval = setInterval(updateTimer, 1000);
        }
        
        async function advanceToLeaderboard() {
            const { data } = await supabaseClient.from('gameRooms').select('status').eq('room_code', gameState.roomCode).single();
            if (data && data.status === 'in_progress') {
                 await supabaseClient.from('gameRooms').update({ status: 'leaderboard' }).eq('room_code', gameState.roomCode);
            }
        }
        
        function loadRealtimeQuestion(roomData) {
            clearInterval(gameTimerInterval);
            const qIndex = roomData.current_question_index;
            if (!gameState.currentQuizData || qIndex < 0) return;
            const question = gameState.currentQuizData.questions[qIndex];
            gameState.questionStartTime = new Date(roomData.question_start_time).getTime();
            
            document.getElementById('questionText').textContent = question.q;
            document.getElementById('currentQuestion').textContent = qIndex + 1;
            document.getElementById('totalQuestions').textContent = gameState.currentQuizData.questions.length;
            document.getElementById('progress-bar').style.width = `${((qIndex + 1) / gameState.currentQuizData.questions.length) * 100}%`;
            
            const qMedia = document.getElementById('questionMedia');
            qMedia.style.display = (question.mediaUrl && question.mediaType === 'image') ? 'block' : 'none';
            qMedia.src = question.mediaUrl || '';
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            const shapes = [{ n: 'triangulo', i: '‚ñ≤' }, { n: 'losango', i: '‚ô¶' }, { n: 'circulo', i: '‚óè' }, { n: 'quadrado', i: '‚ñ†' }];
            question.o.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = `option-button ${shapes[index].n}`;
                btn.innerHTML = `<span class="shape">${shapes[index].i}</span> <span class="text">${opt}</span>`;
                btn.onclick = () => submitAnswer(opt);
                optionsContainer.appendChild(btn);
            });
            
            startTimer(roomData.time_per_question);
        }
        
        async function submitAnswer(selectedAnswer) {
            document.querySelectorAll('.option-button').forEach(b => {
                b.disabled = true;
                if(b.querySelector('.text').textContent === selectedAnswer) b.style.transform = 'scale(1.05)';
             });
            
            const timeTaken = (Date.now() - gameState.questionStartTime) / 1000;
            const { data: roomData } = await supabaseClient.from('gameRooms').select('answers, current_question_index').eq('room_code', gameState.roomCode).single();
            const qIndex = roomData.current_question_index;
            
            const currentAnswers = roomData.answers || {};
            if (!currentAnswers[qIndex]) currentAnswers[qIndex] = {};
            currentAnswers[qIndex][gameState.playerId] = { answer: selectedAnswer, time: timeTaken };

            await supabaseClient.from('gameRooms').update({ answers: currentAnswers }).eq('room_code', gameState.roomCode);
        }
        
        async function showLeaderboard(roomData) {
            clearInterval(gameTimerInterval);
            const qIndex = roomData.current_question_index;
            const question = gameState.currentQuizData.questions[qIndex];
            const correctAnswer = question.a;
            const answers = roomData.answers ? (roomData.answers[qIndex] || {}) : {};
            const basePoints = question.points || 1000;
            let updatedPlayers = { ...roomData.players };

            if (gameState.isHost) {
                Object.keys(updatedPlayers).forEach(playerId => {
                    if (answers[playerId] && answers[playerId].answer === correctAnswer) {
                        const timePenalty = answers[playerId].time * (basePoints / roomData.time_per_question);
                        const pointsGained = Math.max(0, Math.floor(basePoints - timePenalty));
                        if (updatedPlayers[playerId]) {
                            updatedPlayers[playerId].score += pointsGained;
                        }
                    }
                });
                await supabaseClient.from('gameRooms').update({ players: updatedPlayers }).eq('room_code', gameState.roomCode);
            } else {
                updatedPlayers = roomData.players;
            }
            
            const playersList = Object.values(updatedPlayers).sort((a, b) => b.score - a.score);
            const leaderboardContent = document.getElementById('leaderboardContent');
            leaderboardContent.innerHTML = '';
            
            playersList.forEach((player, index) => {
                const isCurrentPlayer = player.id === gameState.playerId;
                let avatarContent = player.avatar || 'üòÄ';
                if (avatarContent.startsWith('data:image')) {
                    avatarContent = `<img src="${player.avatar}" alt="Avatar" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">`;
                }
                leaderboardContent.innerHTML += `<div class="leaderboard-item" style="${isCurrentPlayer ? 'background-color: rgba(0,123,255,0.1);' : ''}"><span class="rank">#${index + 1}</span><span class="name" style="display: flex; align-items: center; gap: 0.5rem;"><span style="font-size: 1.5rem;">${avatarContent}</span>${player.name}</span><span class="score">${player.score}</span></div>`;
            });
            
            document.getElementById('nextQuestionBtn').style.display = gameState.isHost ? 'inline-flex' : 'none';
            document.getElementById('leaderboardTitle').textContent = "Placar Parcial";
            showModal('leaderboardOverlay');
        }
        
        async function handleNextQuestion() {
            if(!gameState.isHost) return;
            const { data: roomData } = await supabaseClient.from('gameRooms').select('current_question_index').eq('room_code', gameState.roomCode).single();
            const newIndex = roomData.current_question_index + 1;
            
            if (newIndex < gameState.currentQuizData.questions.length) {
                await supabaseClient.from('gameRooms').update({
                    status: 'in_progress',
                    current_question_index: newIndex,
                    answers: {},
                    question_start_time: new Date().toISOString()
                }).eq('room_code', gameState.roomCode);
            } else {
                await supabaseClient.from('gameRooms').update({ status: 'finished' }).eq('room_code', gameState.roomCode);
            }
        }
        
        async function showFinalLeaderboard(roomData) {
            showLeaderboard(roomData);
            document.getElementById('leaderboardTitle').textContent = "Placar Final!";
            document.getElementById('nextQuestionBtn').textContent = "Fechar Sala e Salvar";
            document.getElementById('nextQuestionBtn').onclick = leaveLobby;
            
            if(gameState.isHost){
                await supabaseClient.from('results').insert({
                    quiz_id: roomData.quiz_id,
                    room_code: roomData.room_code,
                    players_final: Object.values(roomData.players)
                });
            }
        }

        async function leaveLobby() {
            if (activeListeners.roomChannel) {
                await supabaseClient.removeChannel(activeListeners.roomChannel);
                activeListeners.roomChannel = null;
            }
            if (gameState.isHost && gameState.roomCode) {
                await supabaseClient.from('gameRooms').delete().eq('room_code', gameState.roomCode);
            }
            
            gameState.isHost = false;
            gameState.roomCode = null;
            gameState.currentQuizData = null;
            
            if (gameState.playerEmail) {
                showScreen('professorPanel');
            } else {
                showScreen('mainMenu');
            }
            hideAllModals();
        }

        // L√ìGICA DO AVATAR DO ALUNO
        const avatarPreview = document.getElementById('avatarPreview');
        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const emoji = btn.dataset.emoji;
                studentSelectedAvatar = emoji;
                avatarPreview.innerHTML = emoji;
                avatarPreview.style.fontSize = '3rem';
            });
        });

        document.getElementById('studentAvatarUpload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    studentSelectedAvatar = imageUrl;
                    avatarPreview.innerHTML = `<img src="${imageUrl}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('takePhotoBtn').addEventListener('click', () => {
            showModal('takePhotoModal');
            startCamera();
        });

        document.getElementById('cancelPhotoBtn').addEventListener('click', () => {
            hideAllModals();
        });
        
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                activeListeners.cameraStream = stream;
                const videoElement = document.getElementById('cameraView');
                videoElement.srcObject = stream;
            } catch (err) {
                console.error("Erro ao acessar a c√¢mera: ", err);
                alert("N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes do seu navegador.");
                hideAllModals();
            }
        }

        function stopCamera() {
            if (activeListeners.cameraStream) {
                activeListeners.cameraStream.getTracks().forEach(track => track.stop());
                activeListeners.cameraStream = null;
            }
        }

        document.getElementById('capturePhotoBtn').addEventListener('click', () => {
            const video = document.getElementById('cameraView');
            const canvas = document.getElementById('photoCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageUrl = canvas.toDataURL('image/jpeg');
            studentSelectedAvatar = imageUrl;
            avatarPreview.innerHTML = `<img src="${imageUrl}" alt="Foto Capturada">`;
            
            hideAllModals();
        });
        
        // FIM DA L√ìGICA DO AVATAR

        document.getElementById('leaveLobbyBtn').addEventListener('click', leaveLobby);
        document.querySelector('[data-target="marketplaceScreen"]').addEventListener('click', renderMarketplace);
        document.getElementById('marketplaceSearch').addEventListener('input', renderMarketplace);
        document.getElementById('startGameBtn').addEventListener('click', handleStartGame);
        document.getElementById('nextQuestionBtn').addEventListener('click', handleNextQuestion);
    });
    </script>
</body>
</html>
}
 que mude o nome do projeto no codigo para CienciaMestra e que o sql seja compativel com o novo nome
